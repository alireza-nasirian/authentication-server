name: Build, Publish to JFrog, and Attest (Maven + Docker)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  JF_URL: ${{ vars.JF_URL }}
  JF_REGISTRY: ${{ vars.JF_REGISTRY }}
  OIDC_PROVIDER_NAME: ${{ vars.OIDC_PROVIDER_NAME }}
  OIDC_AUDIENCE: ${{ vars.OIDC_AUDIENCE }}
  JF_MAVEN_DEPLOY_REPO: ${{ vars.JF_MAVEN_DEPLOY_REPO }}
  DOCKER_IMAGE_NAME: ${{ vars.DOCKER_IMAGE_NAME }}
  BUILD_NAME: authentication-server

jobs:
  build-publish-attest:
    runs-on: ubuntu-latest
    environment: JFrog

    permissions:
      contents: read
      id-token: write
      attestations: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Setup JFrog CLI (OIDC)
        id: setup-jfrog-cli
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ env.JF_URL }}
        with:
          oidc-provider-name: ${{ env.OIDC_PROVIDER_NAME }}
          oidc-audience: ${{ env.OIDC_AUDIENCE }}

      # ðŸ”¥ Proper Maven configuration
      - name: Configure Maven for Artifactory
        run: |
          jf rt mvnc \
            --server-id-resolve=artifactory \
            --server-id-deploy=artifactory \
            --repo-deploy-releases=${JF_MAVEN_DEPLOY_REPO} \
            --repo-deploy-snapshots=${JF_MAVEN_DEPLOY_REPO}

      # ðŸ”¥ Deploy using Maven (NO manual upload)
      - name: Maven Build & Deploy
        env:
          JFROG_CLI_BUILD_NAME: ${{ env.BUILD_NAME }}
          JFROG_CLI_BUILD_NUMBER: ${{ github.run_number }}
        run: |
          mvn -B -ntp clean deploy

      # ðŸ”¥ Publish build-info
      - name: Publish Build Info
        run: |
          jf rt bp $BUILD_NAME ${{ github.run_number }}

      # ðŸ”¥ Find built JAR (for attestation only)
      - name: Locate built JAR
        id: jar
        run: |
          JAR_PATH=$(ls target/*.jar | grep -vE '(-sources|-javadoc)\.jar$' | head -n 1)
          echo "jar_path=$JAR_PATH" >> "$GITHUB_OUTPUT"

      - name: Attest JAR (provenance)
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ${{ steps.jar.outputs.jar_path }}

      # ---------------- DOCKER ----------------

      - name: Docker login to JFrog
        uses: docker/login-action@v3
        with:
          registry: ${{ env.JF_REGISTRY }}
          username: ${{ steps.setup-jfrog-cli.outputs.oidc-user }}
          password: ${{ steps.setup-jfrog-cli.outputs.oidc-token }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Docker Image
        id: build-and-push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.JF_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.run_number }}

      - name: Attest Docker Image (provenance)
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: oci://${{ env.JF_REGISTRY }}/${{ env.DOCKER_IMAGE_NAME }}
          subject-digest: ${{ steps.build-and-push.outputs.digest }}
